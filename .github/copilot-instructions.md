# FeyGarden Copilot Instructions

- Stack/workflow: Roblox + Luau with Rojo. Use `serve.ps1` (runs `rojo serve`) for live sync; `build.ps1` (runs `rojo build -o FeyGarden.rbxl`) for place builds. `default.project.json` maps `src/shared`→`ReplicatedStorage/Shared`, `src/setup`→`ReplicatedStorage/Setup`, `src/tools`→`ReplicatedStorage/ToolScripts`, `src/server`→`ServerScriptService/Server`, `src/admin`→`ServerScriptService/Admin`, `src/client`→`StarterPlayer/StarterPlayerScripts/Client`.
- Core server flow (`src/server/MainServer.server.luau`): waits for `Shared` modules (`Constants`, `Config`), loads `DataService` first, then requires `WeatherController`, `EconomyService`, `ToolServer`, `GardenManager` (they create RemoteEvents on require), then initializes weather/economy/gardens. Leaderstats coins mirror DataService coins via polling.
- Persistence (`src/server/Persistence`): `DataService` wraps `DataStoreService` with session locks, autosaves, retry/backoff, and public getters/setters (Add/Remove Coins/Seed/Pet/Fruit, GetAllPlantSlots, etc.). `Schema` defines defaults (Version 1, **1,000,000,000 starting coins**, empty inventories, EquippedPets/GardenPets arrays) and migration. `Config.Economy.EnablePersistence` gates saving; `DataService.ForceSave` is invoked after plant writes. Always check `DataService.IsDataLoaded` before acting on profile (GardenManager already does this).
- Garden system (`src/server/GardenManager.luau`): expects prebuilt gardens in `workspace/Gardens` matching `Config.World` naming (plots under `Plots`, anchors `PlantAnchor1..n`, sign `PlayerSign/Sign`). On init `bootstrapGardens` clears owners/anchors and adds ClickDetectors. Assigns gardens on join (`Config.Garden.AssignOnJoin`), teleports to `TpPart`, updates sign text/colors, restores plants from DataStore when enabled. Garden releases clear/save slots depending on config. Planting uses `Constants.EVENTS.PLANT_SEED`; server validates slot, consumes seed via EconomyService, creates plant model at anchor, caches, and starts growth. Harvest via `Constants.EVENTS.HARVEST_PLANT` pays fruit value and clears slot. Bloom-stage click detectors (set in `SetupPlantHarvestDetector`) allow fruit collection and inventory sync. Slot validity is bounded by `Config.Garden.SlotsPerGarden`.
- Growth logic (`src/shared/PlantModule.luau` + `BuffsModule.luau`): plants cloned from `ReplicatedStorage/Plants/<type>/{seed,plant}`. Attributes track PlantType, Stage, WateredUntil, PetBoost. `PlantModule.GrowPlant` steps through Seed→Sprout→Bloom, using BuffsModule multiplier: weather (`Config.Buffs.Weather`), watered duration (`Config.Tools.WateringCan.WaterSeconds`), pet proximity flag. Stage offsets live in `Constants.STAGE_OFFSETS` (Seed Y+0.5, Sprout +1.5, Bloom +2.5); TASKS mark applying offsets as critical—plants currently spawn at anchor position unless adjusted manually. Bloom triggers harvestable flag and optional click detector setup.
- Weather (`src/server/WeatherController.luau`): cycles every `Constants.WEATHER_CYCLE_TIME` (60s) through Sunny/Rainy/Stormy, tweens Lighting, updates BuffsModule current weather, and fires `Constants.EVENTS.WEATHER_CHANGED` to clients for FX.
- Economy (`src/server/EconomyService.luau`): RemoteEvents for buy/equip/unequip/add/remove pets, buy seeds, sell fruit, update currency/inventory. Uses DataService for truth; seeds/pets/fruits are stored in `profile.Inventory`. New players detected via coins==100 and empty inventory receive starter seeds. `SyncPlayerData` fires currency + inventory (Seeds/Pets/Fruits/EquippedPets/GardenPets) to client. Prices/sell values in `Constants.PLANT_CONFIG`; pet prices/boosts in `Constants.PET_CONFIG`.
- Client init (`src/client/MainClient.client.luau`): waits for Shared, then initializes `UIHandler`, `NPCUIHandler`, `TutorialUI`, `PetController`, `BuffParticles`, `PlantingHandler`. CharacterAdded awaited before init; 1s delay to let server set up remotes.
- Client planting (`src/client/PlantingHandler.luau`): after 2s, finds player garden by matching `OwnerUserId` attribute, attaches click handlers to anchors with ClickDetectors created by GardenManager, asks `UIHandler.GetSelectedPlantType()` for the chosen seed, and fires `PLANT_SEED` RemoteEvent with slot index derived from anchor name.
- Pets client (`src/client/PetController.luau`): spawns equipped pets following player (max 2) and garden pets roaming (max 5) using models from `ReplicatedStorage/Pets`. Uses BodyPosition/BodyGyro for floaty motion, PointLight with pet color, applies pet boost flag to plants within 12 studs to drive BuffsModule multiplier. Garden center guessed from sign text/floor; keep naming consistent.
- Shared content: `Config.luau` documents expected world hierarchy and names (Gardens folder, Plots, Sign, TpPart, ShopPart/SellPart). Audio/VFX configs include many placeholder `rbxassetid://` IDs flagged as TODO in TASKS. `VFXModule` provides fallback sparkles if emitters missing. `NPCModule` contains dialog/metadata for SeedShop/FruitSeller/PetStore; icons include placeholders.
- UI (`src/client/UIHandler.luau`): large prebuilt UI consumed from `StarterGui` (run `src/setup/UISetup.luau` once in Studio). Handles hotbar, inventory, shop/sell windows, weather/currency HUD, notifications, and plays sounds through optional `AudioManager`. Uses RemoteEvents from EconomyService (`UpdateCurrency`, `UpdateInventory`, buy/sell/pet actions) and weather changes. Theme is defined in file; prefers Gotham fonts and fantasy palette.
- Tasks/priorities: see `TASKS.md` for current roadmap—top issues: weather sync/fx, plant stage offsets, sound system finalization, UI/UX polish. Use it to align quick fixes.
- Data folders/models required at runtime: `ReplicatedStorage/Shared`, `ReplicatedStorage/Plants/<type>/{seed,plant}`, `ReplicatedStorage/Pets/<petType>`, `workspace/Gardens/<garden>/Plots/PlantAnchor*`, `PlayerSign/Sign` SurfaceGui TextLabel, optional `TpPart`, shop/sell prompt parts.
- Remote event names (Constants.EVENTS): `WeatherChanged`, `PlantSeed`, `HarvestPlant`, `HarvestFruit`, `BuySeed`, `BuyPet`, `EquipPet`, `UnequipPet`, `AddGardenPet`, `RemoveGardenPet`, `SellFruit`, `UpdateCurrency`, `UpdateInventory`. Many created on require; avoid duplicating names.
- Common pitfalls: ensure Shared folder loads before requiring modules; persistence may be disabled via config—guard saves. Plants currently ignore stage Y offsets unless applied manually; Task list calls this out. DataService uses huge default coins for now; adjust Schema for production. ReplicatedStorage asset folders must exist or Plant/Pet creation will warn and fail.

Let me know if any sections need more detail or if other conventions should be captured.
